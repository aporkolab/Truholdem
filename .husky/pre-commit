#!/bin/sh

# TruHoldem Pre-commit Hook
# Runs linting and tests before allowing commit

echo "ðŸŽ° TruHoldem Pre-commit Checks"
echo "================================"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Track if any check fails
FAILED=0

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# Check if frontend files are staged
FRONTEND_CHANGED=$(echo "$STAGED_FILES" | grep -c "^frontend/" || true)

# Check if backend files are staged
BACKEND_CHANGED=$(echo "$STAGED_FILES" | grep -c "^backend/" || true)

# Frontend checks
if [ "$FRONTEND_CHANGED" -gt 0 ]; then
    echo ""
    echo "${YELLOW}ðŸ“¦ Frontend changes detected${NC}"
    
    # Lint check
    echo "  â†’ Running ESLint..."
    if cd frontend && npm run lint --silent 2>/dev/null; then
        echo "  ${GREEN}âœ“ Lint passed${NC}"
    else
        echo "  ${RED}âœ— Lint failed${NC}"
        echo "  Run 'npm run lint:fix' in frontend/ to auto-fix issues"
        FAILED=1
    fi
    cd ..
    
    # Type check for app code (if TypeScript files changed, excluding cypress and spec files)
    TS_APP_FILES=$(echo "$STAGED_FILES" | grep -E "^frontend/src/.*\.ts$" | grep -v "\.spec\.ts$" || true)
    if [ -n "$TS_APP_FILES" ]; then
        echo "  â†’ Running TypeScript check (app)..."
        if cd frontend && npx tsc --noEmit -p tsconfig.app.json 2>/dev/null; then
            echo "  ${GREEN}âœ“ TypeScript app check passed${NC}"
        else
            echo "  ${RED}âœ— TypeScript errors found in app code${NC}"
            FAILED=1
        fi
        cd ..
    fi

    # Type check for test files (if spec files changed)
    TS_SPEC_FILES=$(echo "$STAGED_FILES" | grep -E "^frontend/src/.*\.spec\.ts$" || true)
    if [ -n "$TS_SPEC_FILES" ]; then
        echo "  â†’ Running TypeScript check (tests)..."
        if cd frontend && npx tsc --noEmit -p tsconfig.spec.json 2>/dev/null; then
            echo "  ${GREEN}âœ“ TypeScript test check passed${NC}"
        else
            echo "  ${RED}âœ— TypeScript errors found in test files${NC}"
            FAILED=1
        fi
        cd ..
    fi

    # Note: Cypress e2e TypeScript checking is skipped in pre-commit
    # because @types/jest and Cypress types conflict in shared node_modules.
    # Cypress validates types when running: npm run e2e or npm run e2e:ci
fi

# Backend checks
if [ "$BACKEND_CHANGED" -gt 0 ]; then
    echo ""
    echo "${YELLOW}â˜• Backend changes detected${NC}"
    
    # Check if Java files changed
    JAVA_FILES=$(echo "$STAGED_FILES" | grep -E "^backend/.*\.java$" || true)
    if [ -n "$JAVA_FILES" ]; then
        echo "  â†’ Running compilation check..."
        if cd backend && ./mvnw compile -q -DskipTests 2>/dev/null; then
            echo "  ${GREEN}âœ“ Compilation passed${NC}"
        else
            echo "  ${RED}âœ— Compilation failed${NC}"
            FAILED=1
        fi
        cd ..
    fi
fi

# Final result
echo ""
echo "================================"
if [ $FAILED -eq 0 ]; then
    echo "${GREEN}âœ“ All pre-commit checks passed!${NC}"
    exit 0
else
    echo "${RED}âœ— Pre-commit checks failed!${NC}"
    echo "Fix the issues above or use 'git commit --no-verify' to skip (not recommended)"
    exit 1
fi
